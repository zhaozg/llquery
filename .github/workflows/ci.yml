name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          # macOS doesn't have gcc by default
          - os: macos-latest
            compiler: gcc
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential valgrind
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install valgrind || echo "Valgrind not available on macOS"
    
    - name: Set compiler
      run: |
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          echo "CC=clang" >> $GITHUB_ENV
        else
          echo "CC=gcc" >> $GITHUB_ENV
        fi
    
    - name: Build library
      run: make clean && make all
    
    - name: Run functionality tests
      run: make test
    
    - name: Build example
      run: make run-example
    
    - name: Check for build artifacts
      run: |
        ls -lh libllquery.a libllquery.so test_llquery benchmark example

  memory-test:
    name: Memory Leak Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Valgrind
      run: |
        sudo apt-get update
        sudo apt-get install -y valgrind build-essential
    
    - name: Build with debug symbols (without ASan for Valgrind compatibility)
      run: |
        make clean
        CC=gcc CFLAGS="-Wall -Wextra -g -std=c99" make test_llquery
    
    - name: Run tests with Valgrind
      run: |
        valgrind --leak-check=full \
                 --show-leak-kinds=all \
                 --track-origins=yes \
                 --verbose \
                 --error-exitcode=1 \
                 ./test_llquery
    
    - name: Run benchmark with Valgrind (limited iterations)
      run: |
        # Create a minimal benchmark test for memory checking
        timeout 60 valgrind --leak-check=full \
                            --show-leak-kinds=all \
                            --error-exitcode=1 \
                            ./benchmark || true

  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Build optimized version
      run: make clean && make all
    
    - name: Run performance benchmark
      run: |
        make run-benchmark | tee benchmark-results.txt
    
    - name: Display benchmark summary
      run: |
        echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat benchmark-results.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark-results.txt
        retention-days: 30

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcovr lcov
    
    - name: Build with coverage
      run: |
        make clean
        CFLAGS="-Wall -Wextra -O0 -g -fprofile-arcs -ftest-coverage" make test_llquery
    
    - name: Run tests
      run: ./test_llquery
    
    - name: Generate coverage report
      run: |
        gcovr --root . --print-summary --xml coverage.xml --html coverage.html
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage.xml
          coverage.html
        retention-days: 30

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=all \
                 --inconclusive \
                 --std=c99 \
                 --suppress=missingIncludeSystem \
                 --error-exitcode=0 \
                 --inline-suppr \
                 llquery.c llquery.h test_llquery.c benchmark.c example.c

  multi-platform-test:
    name: Multi-Platform Build Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, ubuntu-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Build and test
      run: |
        make clean
        make all
        make test
        make run-benchmark
